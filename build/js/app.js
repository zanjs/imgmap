"use strict";var JuLianImageMap=function(){function e(e,t,r){this.target=e,this.eventType=t,this.func=r,e.addEventListener(t,r,!1)}function t(e,i,a,n){this.el=document.createElementNS(r.SVG_NS,"rect"),this.el.classList.add(t.CLASS_NAME),this.el.setAttribute("height",t.SIZE),this.el.setAttribute("width",t.SIZE),this.el.setAttribute("x",i+t.OFFSET),this.el.setAttribute("y",a+t.OFFSET),e.appendChild(this.el),this.el.action=n,this.el.classList.add(t.ACTIONS_TO_CURSORS[n])}function r(e,t){if(this.type=t,this.constructor===r)throw new Error("This is abstract class");this.params={},this.groupEl=document.createElementNS(r.SVG_NS,"g"),a.addNodeToSvg(this.groupEl),this.groupEl.obj=this,this.el=null,this.href="",this.alt="",this.title="",this.helpers={}}var i={getOffset:function(e){var t=e.getBoundingClientRect();return{x:Math.round(t.left+window.pageXOffset),y:Math.round(t.top+window.pageYOffset)}},getRightCoords:function(e,t){return{x:e-a.getOffset("x"),y:t-a.getOffset("y")}},id:function(e){return document.getElementById(e)},hide:function(e){return e.style.display="none",this},show:function(e){return e.style.display="block",this},encode:function(e){return e.replace(/</g,"&lt;").replace(/>/g,"&gt;")},foreach:function(e,t){for(var r=0,i=e.length;i>r;r++)t(e[r],r)},foreachReverse:function(e,t){for(var r=e.length-1;r>=0;r--)t(e[r],r)},debug:function(){var e=document.getElementById("debug");return function(){e.innerHTML=[].join.call(arguments," ")}}(),stopEvent:function(e){return e.stopPropagation(),e.preventDefault(),this},extend:function(e,t){var r={};for(var i in e)e.hasOwnProperty(i)&&(r[i]=t[i]?t[i]:e[i]);return r},inherits:function(){var e=function(){};return function(t,r){e.prototype=r.prototype,t.prototype=new e,t.prototype.constructor=t}}()},a=function(){function t(){m.offset=i.getOffset(g.container)}function r(e){if("editing"===m.appMode)if("g"===e.target.parentNode.tagName)if(o.unload(),m.selectedArea=e.target.parentNode.obj,a.deselectAll(),m.selectedArea.select(),m.selectedArea.delta={x:e.pageX,y:e.pageY},e.target.classList.contains("helper")){var t=e.target;m.editType=t.action,t.n>=0&&(m.selectedArea.selected_point=t.n),a.addEvent(g.container,"mousemove",m.selectedArea.onEdit).addEvent(g.container,"mouseup",m.selectedArea.onEditStop)}else"rect"!==e.target.tagName&&"circle"!==e.target.tagName&&"polygon"!==e.target.tagName||(m.editType="move",a.addEvent(g.container,"mousemove",m.selectedArea.onEdit).addEvent(g.container,"mouseup",m.selectedArea.onEditStop));else a.deselectAll(),o.unload()}function c(e){if("drawing"===m.appMode&&!m.isDraw&&m.currentType)switch(s.hide(),a.setIsDraw(!0),m.currentType){case"rect":m.newArea=new l(i.getRightCoords(e.pageX,e.pageY)),a.addEvent(g.container,"mousemove",m.newArea.onDraw).addEvent(g.container,"click",m.newArea.onDrawStop);break;case"circle":m.newArea=new h(i.getRightCoords(e.pageX,e.pageY)),a.addEvent(g.container,"mousemove",m.newArea.onDraw).addEvent(g.container,"click",m.newArea.onDrawStop);break;case"polygon":m.newArea=new p(i.getRightCoords(e.pageX,e.pageY)),a.addEvent(g.container,"mousemove",m.newArea.onDraw).addEvent(g.container,"click",m.newArea.onDrawAddPoint).addEvent(document,"keydown",m.newArea.onDrawStop).addEvent(m.newArea.helpers[0].el,"click",m.newArea.onDrawStop)}}function u(e){"editing"===m.appMode&&("rect"!==e.target.tagName&&"circle"!==e.target.tagName&&"polygon"!==e.target.tagName||(m.selectedArea=e.target.parentNode.obj,o.load(m.selectedArea,e.pageX,e.pageY)))}function f(e){var t=e.ctrlKey||e.metaKey;switch(e.keyCode){case v.F1:n.show(),e.preventDefault();break;case v.ESC:n.hide(),m.isDraw?(m.isDraw=!1,m.newArea.remove(),m.areas.pop(),a.removeAllEvents()):"editing"===m.appMode&&(m.selectedArea.redraw(),a.removeAllEvents());break;case v.TOP:"editing"===m.appMode&&m.selectedArea&&(m.selectedArea.setParams(m.selectedArea.dynamicEdit(m.selectedArea.move(0,-1))),e.preventDefault());break;case v.BOTTOM:"editing"===m.appMode&&m.selectedArea&&(m.selectedArea.setParams(m.selectedArea.dynamicEdit(m.selectedArea.move(0,1))),e.preventDefault());break;case v.LEFT:"editing"===m.appMode&&m.selectedArea&&(m.selectedArea.setParams(m.selectedArea.dynamicEdit(m.selectedArea.move(-1,0))),e.preventDefault());break;case v.RIGHT:"editing"===m.appMode&&m.selectedArea&&(m.selectedArea.setParams(m.selectedArea.dynamicEdit(m.selectedArea.move(1,0))),e.preventDefault());break;case v.DELETE:"editing"===m.appMode&&m.selectedArea&&(a.removeObject(m.selectedArea),m.selectedArea=null,o.unload());break;case v.I:if("editing"===m.appMode&&m.selectedArea){var r=m.selectedArea.params,i=r.x||r.cx||r[0],s=r.y||r.cy||r[1];o.load(m.selectedArea,i+a.getOffset("x"),s+a.getOffset("y"))}break;case v.S:a.saveInLocalStorage();break;case v.C:if("editing"===m.appMode&&m.selectedArea&&t){var c=y[d.type],d=m.selectedArea.toJSON();c&&(c.createFromSaved(d),m.selectedArea.setParams(m.selectedArea.move(10,10)),m.selectedArea.redraw())}}}var g={wrapper:i.id("wrapper"),svg:i.id("svg"),img:i.id("img"),container:i.id("image"),map:null},m={offset:{x:0,y:0},appMode:null,currentType:null,editType:null,newArea:null,selectedArea:null,areas:[],events:[],isDraw:!1,image:{src:null,filename:null,width:0,height:0}},v={F1:112,ESC:27,TOP:38,BOTTOM:40,LEFT:37,RIGHT:39,DELETE:46,I:73,S:83,C:67},y={rect:l,circle:h,polygon:p};window.addEventListener("resize",t,!1),g.container.addEventListener("mousedown",function(e){e.preventDefault()},!1),g.img.addEventListener("dragstart",function(e){e.preventDefault()},!1);var w=function(){var e=i.id("coords");return{set:function(t){e.innerHTML="x: "+t.x+", y: "+t.y},empty:function(){e.innerHTML=""}}}();g.container.addEventListener("mousemove",function(e){w.set(i.getRightCoords(e.pageX,e.pageY))},!1),g.container.addEventListener("mouseleave",function(){w.empty()},!1),g.container.addEventListener("mousedown",r,!1),g.container.addEventListener("click",c,!1),g.container.addEventListener("dblclick",u,!1),document.addEventListener("keydown",f,!1);var E={toJSON:function(){var e={areas:[],img:m.image.src};return i.foreach(m.areas,function(t){e.areas.push(t.toJSON())}),JSON.stringify(e)},fromJSON:function(e){var t=JSON.parse(e);a.loadImage(t.img),i.foreach(t.areas,function(e){switch(e.type){case"rect":4===e.coords.length&&l.createFromSaved({coords:e.coords,href:e.href,alt:e.alt,title:e.title});break;case"circle":3===e.coords.length&&h.createFromSaved({coords:e.coords,href:e.href,alt:e.alt,title:e.title});break;case"polygon":e.coords.length>=6&&e.coords.length%2===0&&p.createFromSaved({coords:e.coords,href:e.href,alt:e.alt,title:e.title})}})}},S=function(){var e="JuLianImageMap";return{save:function(){window.localStorage.setItem(e,E.toJSON()),alert("Saved")},restore:function(){E.fromJSON(window.localStorage.getItem(e))}}}();return{saveInLocalStorage:S.save,loadFromLocalStorage:S.restore,hide:function(){return i.hide(g.container),this},show:function(){return i.show(g.container),this},recalcOffsetValues:function(){return t(),this},setDimensions:function(e,t){return g.svg.setAttribute("width",e),g.svg.setAttribute("height",t),g.container.style.width=e+"px",g.container.style.height=t+"px",this},loadImage:function(e){return d.showLoadIndicator(),g.img.src=e,m.image.src=e,g.img.onload=function(){d.hideLoadIndicator().hide(),a.show().setDimensions(g.img.width,g.img.height).recalcOffsetValues()},this},preview:function(){return g.img.setAttribute("usemap","#map"),g.map=document.createElement("map"),g.map.setAttribute("name","map"),g.container.appendChild(g.map),function(){return o.unload(),a.setShape(null),i.hide(g.svg),map.innerHTML=a.getHTMLCode(),s.print(),this}}(),hidePreview:function(){return i.show(g.svg),g.map.innerHTML="",this},addNodeToSvg:function(e){return g.svg.appendChild(e),this},removeNodeFromSvg:function(e){return g.svg.removeChild(e),this},getOffset:function(e){switch(e){case"x":return m.offset.x;case"y":return m.offset.y}},clear:function(){for(m.areas.length=0;g.svg.childNodes[0];)g.svg.removeChild(g.svg.childNodes[0]);return s.hide(),o.unload(),this},removeObject:function(e){return i.foreach(m.areas,function(t,r){t===e&&m.areas.splice(r,1)}),e.remove(),this},deselectAll:function(){return i.foreach(m.areas,function(e){e.deselect()}),this},getIsDraw:function(){return m.isDraw},setIsDraw:function(e){return m.isDraw=e,this},setMode:function(e){return m.appMode=e,this},getMode:function(){return m.appMode},setShape:function(e){return m.currentType=e,this},getShape:function(){return m.currentType},addObject:function(e){return m.areas.push(e),this},getNewArea:function(){return m.newArea},resetNewArea:function(){return m.newArea=null,this},getSelectedArea:function(){return m.selectedArea},setSelectedArea:function(e){return m.selectedArea=e,this},getEditType:function(){return m.editType},setFilename:function(e){return m.image.filename=e,this},setEditClass:function(){return g.container.classList.remove("draw"),g.container.classList.add("edit"),this},setDrawClass:function(){return g.container.classList.remove("edit"),g.container.classList.add("draw"),this},setDefaultClass:function(){return g.container.classList.remove("edit"),g.container.classList.remove("draw"),this},addEvent:function(t,r,i){return m.events.push(new e(t,r,i)),this},removeAllEvents:function(){return i.foreach(m.events,function(e){e.remove()}),m.events.length=0,this},getHTMLCode:function(e){var t="";if(e){if(!m.areas.length)return"0 objects";t+=i.encode('<img src="'+m.image.filename+'" alt="" usemap="#map" />')+"<br />"+i.encode('<map name="map">')+"<br />",i.foreachReverse(m.areas,function(e){t+="&nbsp;&nbsp;&nbsp;&nbsp;"+i.encode(e.toString())+"<br />"}),t+=i.encode("</map>")}else i.foreachReverse(m.areas,function(e){t+=e.toString()});return t}}}(),n=function(){function e(){i.hide(r),i.hide(a)}function t(){i.show(r),i.show(a)}var r=i.id("help"),a=i.id("overlay"),n=r.querySelector(".close_button");return a.addEventListener("click",e,!1),n.addEventListener("click",e,!1),{show:t,hide:e}}(),s=function(){var e=i.id("code"),t=i.id("code_content"),r=e.querySelector(".close_button");return r.addEventListener("click",function(t){i.hide(e),t.preventDefault()},!1),{print:function(){t.innerHTML=a.getHTMLCode(!0),i.show(e)},hide:function(){i.hide(e)}}}(),o=function(){function e(){f.classList.remove("changed"),i.foreach(S,function(e){e.classList.remove("changed")})}function t(t){d.href=m.value,d.alt=v.value,d.title=y.value,d[d.href?"with_href":"without_href"](),e(),t.preventDefault()}function r(){d=null,e(),i.hide(f)}function n(e,t){f.style.left=e+5+"px",f.style.top=t+5+"px"}function s(e){n(l+e.pageX-p,h+e.pageY-u)}function o(e){l=l+e.pageX-p,h=h+e.pageY-u,n(l,h),a.removeAllEvents()}function c(){f.classList.add("changed"),this.parentNode.classList.add("changed")}var d,l,h,p,u,f=i.id("edit_details"),g=f.querySelector("h5"),m=i.id("href_attr"),v=i.id("alt_attr"),y=i.id("title_attr"),w=i.id("save_details"),E=f.querySelector(".close_button"),S=f.querySelectorAll("p");return w.addEventListener("click",t,!1),m.addEventListener("keydown",function(e){e.stopPropagation()},!1),v.addEventListener("keydown",function(e){e.stopPropagation()},!1),y.addEventListener("keydown",function(e){e.stopPropagation()},!1),m.addEventListener("change",c,!1),v.addEventListener("change",c,!1),y.addEventListener("change",c,!1),E.addEventListener("click",r,!1),g.addEventListener("mousedown",function(e){p=e.pageX,u=e.pageY,a.addEvent(document,"mousemove",s),a.addEvent(g,"mouseup",o),e.preventDefault()},!1),{load:function(e,t,r){d=e,m.value=e.href?e.href:"",v.value=e.alt?e.alt:"",y.value=e.title?e.title:"",i.show(f),t&&r&&(l=t,h=r,n(l,h))},unload:r}}(),c=function(){function e(e){var t,i,a,n,s,o,g,m,v,y,w=!1;if(e){for(t=c.exec(e);t;){w=!0,g=t[0],s=t[1],o=t[2].split(/ ?, ?/),i=d.exec(g),m=i?i[1]:"",a=u.exec(g),v=a?a[1]:"",n=f.exec(g),y=n?n[1]:"";for(var E=0,S=o.length;S>E;E++)o[E]=Number(o[E]);switch(s){case"rect":4===o.length&&l.createFromSaved({coords:o,href:m,alt:v,title:y});break;case"circle":3===o.length&&h.createFromSaved({coords:o,href:m,alt:v,title:y});break;case"poly":o.length>=6&&o.length%2===0&&p.createFromSaved({coords:o,href:m,alt:v,title:y})}t=c.exec(e)}w&&r()}}function t(t){e(n.value),t.preventDefault()}function r(){i.hide(a)}var a=i.id("from_html_wrapper"),n=i.id("code_input"),s=i.id("load_code_button"),o=a.querySelector(".close_button"),c=/<area(?=.*? shape="(rect|circle|poly)")(?=.*? coords="([\d ,]+?)")[\s\S]*?>/gim,d=/ href="([\S\s]+?)"/,u=/ alt="([\S\s]+?)"/,f=/ title="([\S\s]+?)"/;return s.addEventListener("click",t,!1),o.addEventListener("click",r,!1),{show:function(){n.value="",i.show(a)},hide:r}}(),d=function(){function e(){i.hide(d),u.init(),f.init()}function t(){u.clear(),f.clear(),p=null}function r(e){p===f&&f.test()?a.loadImage(f.getImage()).setFilename(h):p===u&&u.test()&&a.loadImage(u.getImage()).setFilename(h),e.preventDefault()}function n(){t(),i.show(o)}function s(){i.hide(o)}var o=i.id("get_image_wrapper"),c=o.querySelector(".close_button"),d=i.id("loading"),l=i.id("button"),h=null,p=null,u=function(){function e(e){switch(e){case"image/jpeg":case"image/gif":case"image/png":return!0}return!1}function t(){n.src="",i.hide(n).hide(a),r.classList.remove("error"),p=f}var r=i.id("dropzone"),a=r.querySelector(".clear_button"),n=i.id("sm_img");return r.addEventListener("dragover",function(e){i.stopEvent(e)},!1),r.addEventListener("dragleave",function(e){i.stopEvent(e)},!1),r.addEventListener("drop",function(s){i.stopEvent(s);var o=new FileReader,c=s.dataTransfer.files[0];e(c.type)?(r.classList.remove("error"),o.readAsDataURL(c),o.onload=function(e){n.src=e.target.result,n.style.display="inline-block",h=c.name,i.show(a),p=u}):(t(),r.classList.add("error"))},!1),a.addEventListener("click",t,!1),{clear:t,init:function(){r.draggable=!0,this.clear(),i.hide(n).hide(a)},test:function(){return Boolean(n.src)},getImage:function(){return n.src}}}(),f=function(){function e(e){var t,r=e.trim(),i=r.split(".");if(i.length>1)switch(t=i[i.length-1].toLowerCase()){case"jpg":case"jpeg":case"gif":case"png":return!0}return!1}function t(){setTimeout(function(){a.value.length?(i.show(n),p=f):(i.hide(n),p=u)},0)}function r(){a.value="",i.hide(n),a.classList.remove("error"),p=f}var a=i.id("url"),n=a.parentNode.querySelector(".clear_button");return a.addEventListener("keypress",t,!1),a.addEventListener("change",t,!1),a.addEventListener("paste",t,!1),n.addEventListener("click",r,!1),{clear:r,init:function(){this.clear(),i.hide(n)},test:function(){return e(a.value)?(a.classList.remove("error"),!0):(a.classList.add("error"),!1)},getImage:function(){var e=a.value.split("/");return h=e[e.length-1],a.value.trim()}}}();return e(),l.addEventListener("click",r,!1),c.addEventListener("click",s,!1),{show:function(){return a.hide(),n(),this},hide:function(){return a.show(),s(),this},showLoadIndicator:function(){return i.show(d),this},hideLoadIndicator:function(){return i.hide(d),this}}}();d.show();(function(){function e(){i.foreach(E,function(e){e.classList.remove(r.CLASS_NAMES.SELECTED)})}function t(t){e(),t.classList.add(r.CLASS_NAMES.SELECTED)}function l(e){a.saveInLocalStorage(),e.preventDefault()}function h(e){a.clear().loadFromLocalStorage(),e.preventDefault()}function p(e){a.setMode("drawing").setDrawClass().setShape(this.id).deselectAll().hidePreview(),o.unload(),t(this),e.preventDefault()}function u(t){confirm("Clear all?")&&(a.setMode(null).setDefaultClass().setShape(null).clear().hidePreview(),e()),t.preventDefault()}function f(e){c.show(),e.preventDefault()}function g(e){o.unload(),s.print(),e.preventDefault()}function m(r){"preview"===a.getMode()?(a.setMode(null).hidePreview(),e()):(a.deselectAll().setMode("preview").setDefaultClass().preview(),t(this)),r.preventDefault()}function v(r){"editing"===a.getMode()?(a.setMode(null).setDefaultClass().deselectAll(),e(),i.show(domElements.svg)):(a.setShape(null).setMode("editing").setEditClass(),t(this)),a.hidePreview(),r.preventDefault()}function y(t){confirm("Discard all changes?")&&(a.setMode(null).setDefaultClass().setShape(null).setIsDraw(!1).clear().hide().hidePreview(),e(),d.show()),t.preventDefault()}function w(e){n.show(),e.preventDefault()}var E=i.id("nav").getElementsByTagName("li"),S=i.id("save"),A=i.id("load"),L=i.id("rect"),b=i.id("circle"),x=i.id("polygon"),C=i.id("edit"),D=i.id("clear"),M=i.id("from_html"),T=i.id("to_html"),N=i.id("preview"),_=i.id("new_image"),O=i.id("show_help");S.addEventListener("click",l,!1),A.addEventListener("click",h,!1),L.addEventListener("click",p,!1),b.addEventListener("click",p,!1),x.addEventListener("click",p,!1),D.addEventListener("click",u,!1),M.addEventListener("click",f,!1),T.addEventListener("click",g,!1),N.addEventListener("click",m,!1),C.addEventListener("click",v,!1),_.addEventListener("click",y,!1),O.addEventListener("click",w,!1)})();e.prototype.remove=function(){this.target.removeEventListener(this.eventType,this.func,!1)},t.SIZE=5,t.OFFSET=-Math.ceil(t.SIZE/2),t.CLASS_NAME="helper",t.ACTIONS_TO_CURSORS={move:"move",editLeft:"e-resize",editRight:"w-resize",editTop:"n-resize",editBottom:"s-resize",editTopLeft:"nw-resize",editTopRight:"ne-resize",editBottomLeft:"sw-resize",editBottomRight:"se-resize",pointMove:"pointer"},t.prototype.setCoords=function(e,r){return this.el.setAttribute("x",e+t.OFFSET),this.el.setAttribute("y",r+t.OFFSET),this},t.prototype.setId=function(e){return this.el.n=e,this},r.SVG_NS="http://www.w3.org/2000/svg",r.CLASS_NAMES={SELECTED:"selected",WITH_HREF:"with_href"},r.prototype.remove=function(){a.removeNodeFromSvg(this.groupEl)},r.prototype.select=function(){return this.el.classList.add(r.CLASS_NAMES.SELECTED),this},r.prototype.deselect=function(){return this.el.classList.remove(r.CLASS_NAMES.SELECTED),this},r.prototype.with_href=function(){return this.el.classList.add(r.CLASS_NAMES.WITH_HREF),this},r.prototype.without_href=function(){return this.el.classList.remove(r.CLASS_NAMES.WITH_HREF),this},r.prototype.setInfoAttributes=function(e){e.href&&(this.href=e.href),e.alt&&(this.alt=e.alt),e.title&&(this.title=e.title)},r.prototype.toJSON=function(){return{type:"polygon",coords:this.params,href:this.href,alt:this.alt,title:this.title}};var l=function(e){r.call(this,e,"rectangle"),this.params={x:e.x,y:e.y,width:0,height:0},this.el=document.createElementNS(r.SVG_NS,"rect"),this.groupEl.appendChild(this.el);var i=e.x-this.params.width/2,n=e.y-this.params.height/2;this.helpers={center:new t(this.groupEl,i,n,"move"),top:new t(this.groupEl,i,n,"editTop"),bottom:new t(this.groupEl,i,n,"editBottom"),left:new t(this.groupEl,i,n,"editLeft"),right:new t(this.groupEl,i,n,"editRight"),top_left:new t(this.groupEl,i,n,"editTopLeft"),top_right:new t(this.groupEl,i,n,"editTopRight"),bottom_left:new t(this.groupEl,i,n,"editBottomLeft"),bottom_right:new t(this.groupEl,i,n,"editBottomRight")},this.select().redraw(),a.addObject(this)};i.inherits(l,r),l.prototype.setCoords=function(e){return this.el.setAttribute("x",e.x),this.el.setAttribute("y",e.y),this.el.setAttribute("width",e.width),this.el.setAttribute("height",e.height),this.helpers.center.setCoords(e.x+e.width/2,e.y+e.height/2),this.helpers.top.setCoords(e.x+e.width/2,e.y),this.helpers.bottom.setCoords(e.x+e.width/2,e.y+e.height),this.helpers.left.setCoords(e.x,e.y+e.height/2),this.helpers.right.setCoords(e.x+e.width,e.y+e.height/2),this.helpers.top_left.setCoords(e.x,e.y),this.helpers.top_right.setCoords(e.x+e.width,e.y),this.helpers.bottom_left.setCoords(e.x,e.y+e.height),this.helpers.bottom_right.setCoords(e.x+e.width,e.y+e.height),this},l.prototype.setParams=function(e){return this.params.x=e.x,this.params.y=e.y,this.params.width=e.width,this.params.height=e.height,this},l.prototype.redraw=function(){return this.setCoords(this.params),this},l.prototype.dynamicDraw=function(e,t,r){var i,a,n,s,o,c,d=this.params.x,l=this.params.y;return n=Math.abs(e-d),s=Math.abs(t-l),r&&(o=n-s,o>0?n=s:s=n),d>e?(i=e,r&&o>0&&(i=e+Math.abs(o))):i=d,l>t?(a=t,r&&0>o&&(a=t+Math.abs(o))):a=l,c={x:i,y:a,width:n,height:s},this.setCoords(c),c},l.prototype.onDraw=function(e){var t=a.getNewArea(),r=e.shiftKey,n=i.getRightCoords(e.pageX,e.pageY);t.dynamicDraw(n.x,n.y,r)},l.prototype.onDrawStop=function(e){var t=a.getNewArea(),r=e.shiftKey,n=i.getRightCoords(e.pageX,e.pageY);t.setParams(t.dynamicDraw(n.x,n.y,r)).deselect(),a.removeAllEvents().setIsDraw(!1).resetNewArea()},l.prototype.move=function(e,t){var r=Object.create(this.params);return r.x+=e,r.y+=t,r},l.prototype.editLeft=function(e,t){var r=Object.create(this.params);return r.x+=e,r.width-=e,r},l.prototype.editRight=function(e,t){var r=Object.create(this.params);return r.width+=e,r},l.prototype.editTop=function(e,t){var r=Object.create(this.params);return r.y+=t,r.height-=t,r},l.prototype.editBottom=function(e,t){var r=Object.create(this.params);return r.height+=t,r},l.prototype.editTopLeft=function(e,t){var r=Object.create(this.params);return r.x+=e,r.y+=t,r.width-=e,r.height-=t,r},l.prototype.editTopRight=function(e,t){var r=Object.create(this.params);return r.y+=t,r.width+=e,r.height-=t,r},l.prototype.editBottomLeft=function(e,t){var r=Object.create(this.params);return r.x+=e,r.width-=e,r.height+=t,r},l.prototype.editBottomRight=function(e,t){var r=Object.create(this.params);return r.width+=e,r.height+=t,r},l.prototype.dynamicEdit=function(e,t){if(e.width<0&&(e.width=Math.abs(e.width),e.x-=e.width),e.height<0&&(e.height=Math.abs(e.height),e.y-=e.height),t){var r=this.params.width/this.params.height,i=e.width/e.height,a=i-r;this.params.x,this.params.y,e.x,e.y;a>0?e.width=Math.round(e.height*r):e.height=Math.round(e.width/r)}return this.setCoords(e),e},l.prototype.onEdit=function(e){var t=a.getSelectedArea(),r=e.shiftKey,i=a.getEditType();t.dynamicEdit(t[i](e.pageX-t.delta.x,e.pageY-t.delta.y),r)},l.prototype.onEditStop=function(e){var t=a.getSelectedArea(),r=a.getEditType(),i=e.shiftKey;t.setParams(t.dynamicEdit(t[r](e.pageX-t.delta.x,e.pageY-t.delta.y),i)),a.removeAllEvents()},l.prototype.toString=function(){var e=this.params.x+this.params.width,t=this.params.y+this.params.height;return'<area shape="rect" coords="'+this.params.x+", "+this.params.y+", "+e+", "+t+'"'+(this.href?' href="'+this.href+'"':"")+(this.alt?' alt="'+this.alt+'"':"")+(this.title?' title="'+this.title+'"':"")+" />"},l.createFromSaved=function(e){a.setIsDraw(!0);var t=new l({x:e.coords[0],y:e.coords[1]});t.setParams(t.dynamicDraw(e.coords[2],e.coords[3])).deselect(),a.setIsDraw(!1).resetNewArea(),t.setInfoAttributes(e)},l.prototype.toJSON=function(){return{type:"rect",coords:[this.params.x,this.params.y,this.params.x+this.params.width,this.params.y+this.params.height],href:this.href,alt:this.alt,title:this.title}};var h=function(e){r.call(this,e,"circle"),this.params={cx:e.x,cy:e.y,radius:0},this.el=document.createElementNS(r.SVG_NS,"circle"),this.groupEl.appendChild(this.el),this.helpers={center:new t(this.groupEl,e.x,e.y,"move"),top:new t(this.groupEl,e.x,e.y,"editTop"),bottom:new t(this.groupEl,e.x,e.y,"editBottom"),left:new t(this.groupEl,e.x,e.y,"editLeft"),right:new t(this.groupEl,e.x,e.y,"editRight")},this.select().redraw(),a.addObject(this)};i.inherits(h,r),h.prototype.setCoords=function(e){return this.el.setAttribute("cx",e.cx),this.el.setAttribute("cy",e.cy),this.el.setAttribute("r",e.radius),this.helpers.center.setCoords(e.cx,e.cy),this.helpers.top.setCoords(e.cx,e.cy-e.radius),this.helpers.right.setCoords(e.cx+e.radius,e.cy),this.helpers.bottom.setCoords(e.cx,e.cy+e.radius),this.helpers.left.setCoords(e.cx-e.radius,e.cy),this},h.prototype.setParams=function(e){return this.params.cx=e.cx,this.params.cy=e.cy,this.params.radius=e.radius,this},h.prototype.redraw=function(){return this.setCoords(this.params),this},h.prototype.dynamicDraw=function(e,t){var r,i,a,n,s=this.params.cx,o=this.params.cy;return e=e||s,t=t||o,r=Math.abs(s-e),i=Math.abs(o-t),a=Math.round(Math.sqrt(r*r+i*i)),n={cx:s,cy:o,radius:a},this.setCoords(n),n},h.prototype.onDraw=function(e){var t=a.getNewArea(),r=i.getRightCoords(e.pageX,e.pageY);t.dynamicDraw(r.x,r.y)},h.prototype.onDrawStop=function(e){var t=a.getNewArea(),r=i.getRightCoords(e.pageX,e.pageY);t.setParams(t.dynamicDraw(r.x,r.y)).deselect(),a.removeAllEvents().setIsDraw(!1).resetNewArea()},h.prototype.move=function(e,t){var r=Object.create(this.params);return r.cx+=e,r.cy+=t,r},h.prototype.editTop=function(e,t){var r=Object.create(this.params);return r.radius-=t,r},h.prototype.editBottom=function(e,t){var r=Object.create(this.params);return r.radius+=t,r},h.prototype.editLeft=function(e,t){var r=Object.create(this.params);return r.radius-=e,r},h.prototype.editRight=function(e,t){var r=Object.create(this.params);return r.radius+=e,r},h.prototype.dynamicEdit=function(e){return e.radius<0&&(e.radius=Math.abs(e.radius)),this.setCoords(e),e},h.prototype.onEdit=function(e){var t=a.getSelectedArea(),r=a.getEditType();t.dynamicEdit(t[r](e.pageX-t.delta.x,e.pageY-t.delta.y))},h.prototype.onEditStop=function(e){var t=a.getSelectedArea(),r=a.getEditType();t.setParams(t.dynamicEdit(t[r](e.pageX-t.delta.x,e.pageY-t.delta.y))),a.removeAllEvents()},h.prototype.toString=function(){return'<area shape="circle" coords="'+this.params.cx+", "+this.params.cy+", "+this.params.radius+'"'+(this.href?' href="'+this.href+'"':"")+(this.alt?' alt="'+this.alt+'"':"")+(this.title?' title="'+this.title+'"':"")+" />"},h.createFromSaved=function(e){a.setIsDraw(!0);var t=new h({x:e.coords[0],y:e.coords[1]});t.setParams(t.dynamicDraw(e.coords[0],e.coords[1]+e.coords[2])).deselect(),a.setIsDraw(!1).resetNewArea(),t.setInfoAttributes(e)},h.prototype.toJSON=function(){return{type:"circle",coords:[this.params.cx,this.params.cy,this.params.radius],href:this.href,alt:this.alt,title:this.title}};var p=function(e){r.call(this,e,"polygon"),this.params=[e.x,e.y],this.el=document.createElementNS(r.SVG_NS,"polyline"),this.groupEl.appendChild(this.el),this.helpers=[new t(this.groupEl,this.params[0],this.params[1],"pointMove").setId(0)],this.selected_point=-1,this.select().redraw(),a.addObject(this)};i.inherits(p,r),p.prototype.setCoords=function(e){var t=e.join(" ");return this.el.setAttribute("points",t),i.foreach(this.helpers,function(t,r){t.setCoords(e[2*r],e[2*r+1])}),this},p.prototype.setParams=function(e){return this.params=Array.prototype.slice.call(e),this},p.prototype.addPoint=function(e,r){var i=new t(this.groupEl,e,r,"pointMove");return i.setId(this.helpers.length),this.helpers.push(i),this.params.push(e,r),this.redraw(),this},p.prototype.redraw=function(){return this.setCoords(this.params),this},p.prototype.right_angle=function(e,t){var r=this.params[this.params.length-2],i=this.params[this.params.length-1],a=e-r,n=-(t-i),s=n/a;return a>0&&n>0?s>2.414?e=r:.414>s?t=i:Math.abs(a)>Math.abs(n)?e=r+n:t=i-a:0>a&&n>0?-2.414>s?e=r:s>-.414?t=i:Math.abs(a)>Math.abs(n)?e=r-n:t=i+a:0>a&&0>n?s>2.414?e=r:.414>s?t=i:Math.abs(a)>Math.abs(n)?e=r+n:t=i-a:a>0&&0>n&&(-2.414>s?e=r:s>-.414?t=i:Math.abs(a)>Math.abs(n)?e=r-n:t=i+a),{x:e,y:t}},p.prototype.dynamicDraw=function(e,t,r){var i=[].concat(this.params);if(r){var a=this.right_angle(e,t);e=a.x,t=a.y}return i.push(e,t),this.setCoords(i),i},p.prototype.onDraw=function(e){var t=a.getNewArea(),r=e.shiftKey,n=i.getRightCoords(e.pageX,e.pageY);t.dynamicDraw(n.x,n.y,r)},p.prototype.onDrawAddPoint=function(e){var t=a.getNewArea(),r=i.getRightCoords(e.pageX,e.pageY);if(e.shiftKey)var n=t.right_angle(r.x,r.y);t.addPoint(n.x,n.y)},p.prototype.onDrawStop=function(e){var t=a.getNewArea();("click"==e.type||"keydown"==e.type&&13==e.keyCode)&&t.params.length>=6&&(t.polyline=t.el,t.el=document.createElementNS(r.SVG_NS,"polygon"),t.groupEl.replaceChild(t.el,t.polyline),t.setCoords(t.params).deselect(),delete t.polyline,a.removeAllEvents().setIsDraw(!1).resetNewArea()),e.stopPropagation()},p.prototype.move=function(e,t){for(var r=Object.create(this.params),i=0,a=this.params.length;a>i;i++)this.params[i]+=i%2?t:e;return r},p.prototype.pointMove=function(e,t){return this.params[2*this.selected_point]+=e,this.params[2*this.selected_point+1]+=t,this.params},p.prototype.dynamicEdit=function(e){return this.setCoords(e),e},p.prototype.onEdit=function(e){var t=a.getSelectedArea(),r=a.getEditType();t.dynamicEdit(t[r](e.pageX-t.delta.x,e.pageY-t.delta.y)),t.delta.x=e.pageX,t.delta.y=e.pageY},p.prototype.onEditStop=function(e){var t=a.getSelectedArea(),r=a.getEditType();t.setParams(t.dynamicEdit(t[r](e.pageX-t.delta.x,e.pageY-t.delta.y))),a.removeAllEvents()},p.prototype.toString=function(){for(var e=0,t=this.params.length,r="";t>e;e++)r+=this.params[e],e!=t-1&&(r+=", ");return'<area shape="poly" coords="'+r+'"'+(this.href?' href="'+this.href+'"':"")+(this.alt?' alt="'+this.alt+'"':"")+(this.title?' title="'+this.title+'"':"")+" />"},p.createFromSaved=function(e){a.setIsDraw(!0);for(var t=new p({x:e.coords[0],y:e.coords[1]}),i=2,n=e.coords.length;n>i;i+=2)t.addPoint(e.coords[i],e.coords[i+1]);t.polyline=t.el,t.el=document.createElementNS(r.SVG_NS,"polygon"),t.groupEl.replaceChild(t.el,t.polyline),t.setCoords(t.params).deselect(),delete t.polyline,a.setIsDraw(!1).resetNewArea(),t.setInfoAttributes(e)}}();